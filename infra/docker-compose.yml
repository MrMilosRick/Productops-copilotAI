services:
  db:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_DB: copilot
      POSTGRES_USER: copilot
      POSTGRES_PASSWORD: copilot
    volumes:
      - copilot_pgdata:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    restart: unless-stopped

  web:
    build:
      context: ../backend
      dockerfile: Dockerfile
    env_file:
      - ../.env
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-copilot}
      POSTGRES_USER: ${POSTGRES_USER:-copilot}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-copilot}
      POSTGRES_HOST: ${POSTGRES_HOST:-db}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
    depends_on:
      - db
      - redis
    ports:
      - "8001:8000"
    restart: unless-stopped
    command: >
      bash -lc "
      echo 'Waiting for DB...' &&
      for i in {1..60}; do
        python -c \"import os, psycopg; host=os.getenv('POSTGRES_HOST','db'); port=int(os.getenv('POSTGRES_PORT','5432')); db=os.getenv('POSTGRES_DB','copilot'); user=os.getenv('POSTGRES_USER','copilot'); pw=os.getenv('POSTGRES_PASSWORD','copilot'); psycopg.connect(host=host, port=port, dbname=db, user=user, password=pw, connect_timeout=2).close(); print('DB ready')\" && break || true
        echo '...still waiting' && sleep 1
      done &&
      python manage.py migrate &&
      gunicorn app.wsgi:application --bind 0.0.0.0:8000
      "

  worker:
    build:
      context: ../backend
      dockerfile: Dockerfile
    env_file:
      - ../.env
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-copilot}
      POSTGRES_USER: ${POSTGRES_USER:-copilot}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-copilot}
      POSTGRES_HOST: ${POSTGRES_HOST:-db}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
    depends_on:
      - db
      - redis
    restart: unless-stopped
    command: >
      bash -lc "celery -A app worker -l INFO"

volumes:
  copilot_pgdata:
