services:
  db:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_DB: copilot
      POSTGRES_USER: copilot
      POSTGRES_PASSWORD: copilot
    volumes:
      - copilot_pgdata:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    restart: unless-stopped

  web:
    build:
      context: ../backend
      dockerfile: Dockerfile
    env_file:
      - ../.env
    depends_on:
      - db
      - redis
    ports:
      - "8001:8000"
    restart: unless-stopped
    user: "0:0"
    volumes:
      - copilot_uploads:/app/uploads
    command: >
      bash -lc "
      mkdir -p /app/uploads && chown -R app:app /app/uploads &&
      echo 'Waiting for DB...' &&
      for i in {1..60}; do
        python -c \"import os, psycopg; host=os.getenv('POSTGRES_HOST','db'); port=int(os.getenv('POSTGRES_PORT','5432')); db=os.getenv('POSTGRES_DB','copilot'); user=os.getenv('POSTGRES_USER','copilot'); pw=os.getenv('POSTGRES_PASSWORD','copilot'); psycopg.connect(host=host, port=port, dbname=db, user=user, password=pw, connect_timeout=2).close(); print('DB ready')\" && break || true
        echo '...still waiting' && sleep 1
      done &&
      python manage.py migrate &&
      python manage.py runserver 0.0.0.0:8000
      "

  worker:
    build:
      context: ../backend
      dockerfile: Dockerfile
    env_file:
      - ../.env
    depends_on:
      - db
      - redis
    restart: unless-stopped
    user: "0:0"
    volumes:
      - copilot_uploads:/app/uploads
    command: >
      bash -lc "mkdir -p /app/uploads && chown -R app:app /app/uploads && celery -A app worker -l INFO"

volumes:
  copilot_pgdata:
  copilot_uploads: