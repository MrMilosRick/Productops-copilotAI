services:
  db:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_DB: copilot
      POSTGRES_USER: copilot
      POSTGRES_PASSWORD: copilot
    volumes:
      - copilot_pgdata:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    restart: unless-stopped

  uploads-init:
    build:
      context: ../backend
      dockerfile: Dockerfile
    user: "0:0"
    volumes:
      - copilot_uploads:/app/uploads
    command: ["sh", "-lc", "mkdir -p /app/uploads && (chmod -R a+rwx /app/uploads || true) && (chown -R 100:101 /app/uploads || true)"]

  web:
    build:
      context: ../backend
      dockerfile: Dockerfile
    env_file:
      - ../.env
    environment:
      OPENAI_MAX_OUTPUT_TOKENS: "1200"
    depends_on:
      db: { condition: service_started }
      redis: { condition: service_started }
      uploads-init: { condition: service_completed_successfully }
    ports:
      - "127.0.0.1:18001:8000"
    restart: unless-stopped
    user: "100:101"
    volumes:
      - copilot_uploads:/app/uploads
    command: >
      bash -lc "
      echo 'Waiting for DB...' &&
      for i in {1..60}; do
        python -c \"import os, psycopg; host=os.getenv('POSTGRES_HOST','db'); port=int(os.getenv('POSTGRES_PORT','5432')); db=os.getenv('POSTGRES_DB','copilot'); user=os.getenv('POSTGRES_USER','copilot'); pw=os.getenv('POSTGRES_PASSWORD','copilot'); psycopg.connect(host=host, port=port, dbname=db, user=user, password=pw, connect_timeout=2).close(); print('DB ready')\" && break || true
        echo '...still waiting' && sleep 1
      done &&
      python manage.py migrate &&
      gunicorn app.wsgi:application --bind 0.0.0.0:8000 --access-logfile - --error-logfile - --log-level info --capture-output
      "

  worker:
    build:
      context: ../backend
      dockerfile: Dockerfile
    env_file:
      - ../.env
    environment:
      OPENAI_MAX_OUTPUT_TOKENS: "1200"
    depends_on:
      db: { condition: service_started }
      redis: { condition: service_started }
      uploads-init: { condition: service_completed_successfully }
    restart: unless-stopped
    user: "100:101"
    volumes:
      - copilot_uploads:/app/uploads
    command: >
      bash -lc "celery -A app worker -l INFO"

volumes:
  copilot_pgdata:
  copilot_uploads: